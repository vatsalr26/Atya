<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Atya - Login / Register</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=MuseoModerno:wght@700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'sans-serif'],
            heading: ['MuseoModerno', 'sans-serif'],
          },
          colors: {
            'primary-dark-teal': '#003B3E',
            'primary-teal': '#016367',
            'secondary-medium-teal': '#01949A',
            'secondary-seafoam': '#49C3A3',
            'neutral-dark-grey': '#7A7A7A',
            'neutral-grey': '#B4B4B4',
            'neutral-light-gray-blue': '#D9E3E5',
            'neutral-light-grey': '#E8E8E8',
            'neutral-off-white': '#FAFAFA',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'DM Sans', sans-serif;
    }
  </style>
  <script src="js/api.js" type="module"></script>
  <script src="js/auth.js" type="module"></script>
</head>
<body class="bg-neutral-off-white text-neutral-dark-grey">

  <header class="bg-white/80 backdrop-blur-lg fixed top-0 left-0 right-0 z-50 border-b border-neutral-light-grey">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <a href="index.html" class="text-2xl font-heading font-bold text-primary-dark-teal">
        Atya
      </a>

    </div>
  </header>

  <main class="pt-32 pb-20">
    <div class="container mx-auto px-6 max-w-md bg-white p-8 rounded-lg shadow-md border border-neutral-light-grey">
      <div class="flex justify-center mb-8">
        <button class="tab-btn px-4 py-2 font-bold text-primary-teal border-b-2 border-primary-teal" data-tab="login">Login</button>
      </div>

      <form id="loginForm" class="auth-form active">
        <h2 class="text-2xl font-bold text-primary-dark-teal mb-6 text-center">Welcome Back</h2>
        <div class="mb-4">
          <label for="loginEmail" class="block font-medium mb-1">Email</label>
          <input type="email" id="loginEmail" required class="w-full px-4 py-2 border border-neutral-light-grey rounded-lg focus:outline-none focus:border-primary-teal">
        </div>
        <div class="mb-4">
          <label for="loginPassword" class="block font-medium mb-1">Password</label>
          <input type="password" id="loginPassword" required class="w-full px-4 py-2 border border-neutral-light-grey rounded-lg focus:outline-none focus:border-primary-teal">
        </div>
        <button type="submit" class="w-full bg-primary-teal text-white py-3 rounded-lg font-bold hover:bg-secondary-medium-teal transition-all">Login</button>
        <div class="mt-6 space-y-3">
          <a href="#" class="block w-full text-center border border-neutral-light-grey rounded-lg py-2 hover:bg-neutral-light-grey transition">Continue with Google</a>
          <a href="#" class="block w-full text-center border border-neutral-light-grey rounded-lg py-2 hover:bg-neutral-light-grey transition">Continue with LinkedIn</a>
        </div>
      </form>

      <div class="mt-6 text-center">
        <p class="text-neutral-grey">
          No account? 
          <a href="register.html" class="text-primary-teal font-medium hover:underline">Create one here</a>
        </p>
      </div>

      <script type="module">
        import { auth } from './js/api.js';
      
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          
          try {
            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Logging in...';
            
            // Login the user
            const response = await auth.login({ email, password });
            
            // Store the JWT token
            localStorage.setItem('token', response.access_token);
            
            // Get user data from response or fall back to localStorage
            let user = response.user || JSON.parse(localStorage.getItem('user') || '{}');
            
            // If no role in response or localStorage, use email domain as fallback
            if (!user.role) {
              const isUniversityEmail = email.endsWith('.edu') || email.includes('university') || email.includes('college');
              user = {
                email: email,
                name: response.name || email.split('@')[0],
                role: isUniversityEmail ? 'UNIVERSITY_STAFF' : 'RESEARCHER',
                universityName: isUniversityEmail ? 'University' : null
              };
            } else {
              // Ensure we have all required user fields
              user = {
                email: email,
                name: response.name || user.name || email.split('@')[0],
                role: user.role, // Keep the role from response or localStorage
                universityName: user.role === 'UNIVERSITY_STAFF' ? (user.universityName || 'University') : null
              };
            }
            
            console.log('Logging in user:', user);
            // Store updated user data in localStorage
            localStorage.setItem('user', JSON.stringify(user));
            
            // Force redirect to the correct dashboard based on role
            const dashboardUrl = (userRole || '').toUpperCase() === 'UNIVERSITY_STAFF' 
              ? 'university-dashboard.html' 
              : 'dashboard.html';
              
            console.log('Redirecting to:', dashboardUrl, 'for role:', userRole);
            window.location.href = dashboardUrl;
          } catch (error) {
            console.error('Login error:', error);
            alert(error.message || 'Invalid email or password');
          } finally {
            // Reset button state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
          }
        });
      </script>

</body>
</html>
